openapi: 3.0.0
info:
  title: AI Fabric Analysis & PLM Integration API
  description: |
    ChatGPT Vision ile kumaÅŸ etiket gÃ¶rsellerini analiz edip PLM'de otomatik kumaÅŸ kodu aÃ§an API.
    
    **AkÄ±ÅŸ:**
    1. PLM'den gÃ¶rsel URL alÄ±nÄ±r
    2. ChatGPT ile gÃ¶rsel analiz edilir
    3. Elyaf mapping yapÄ±lÄ±r
    4. PLM'de kumaÅŸ kodu aÃ§Ä±lÄ±r
    
    **Ã–zellikler:**
    - âœ… ChatGPT GPT-4o Vision entegrasyonu
    - âœ… 9 farklÄ± elyaf tipi, 40+ kod varyasyonu
    - âœ… Dinamik elyaf desteÄŸi (1-5 elyaf)
    - âœ… OAuth 2.0 token yÃ¶netimi
    - âœ… Infor Fashion PLM entegrasyonu
    - âœ… ION API formatÄ±
    
  version: 1.0.0
  contact:
    email: kaan.karaca93@gmail.com
  license:
    name: MIT

servers:
  - url: https://your-app.herokuapp.com
    description: Production server (Heroku)
  - url: http://localhost:5000
    description: Development server

tags:
  - name: Health
    description: API saÄŸlÄ±k kontrolÃ¼
  - name: Analysis
    description: GÃ¶rsel analizi
  - name: Full Flow
    description: Analiz + PLM kumaÅŸ aÃ§ma

paths:
  /health:
    get:
      tags:
        - Health
      summary: API saÄŸlÄ±k kontrolÃ¼
      description: API'nin Ã§alÄ±ÅŸÄ±p Ã§alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± kontrol eder
      responses:
        '200':
          description: API Ã§alÄ±ÅŸÄ±yor
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: healthy
                  message:
                    type: string
                    example: KumaÅŸ Analiz API Ã§alÄ±ÅŸÄ±yor
                  timestamp:
                    type: string
                    format: date-time
                    example: 2025-12-04T12:00:00.000Z

  /health/detailed:
    get:
      tags:
        - Health
      summary: DetaylÄ± saÄŸlÄ±k kontrolÃ¼ (tÃ¼m servisler)
      description: |
        API'nin ve baÄŸlÄ± servislerin (OpenAI, PLM, GitHub) durumunu kontrol eder.
        
        **Kontrol edilen servisler:**
        - âœ… Express API
        - âœ… OpenAI API (GPT-4o Vision)
        - âœ… PLM API (OAuth token)
        - â„¹ï¸ GitHub (repository info)
      responses:
        '200':
          description: TÃ¼m servisler saÄŸlÄ±klÄ±
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DetailedHealthResponse'
        '503':
          description: BazÄ± servisler Ã§alÄ±ÅŸmÄ±yor (degraded)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DetailedHealthResponse'

  /analyze:
    post:
      tags:
        - Analysis
      summary: KumaÅŸ gÃ¶rselini analiz et
      description: |
        PLM gÃ¶rsel URL'ini alÄ±r, ChatGPT ile analiz eder ve PLM formatÄ±nda sonuÃ§ dÃ¶ner.
        
        **Ã‡Ä±ktÄ±:** TedarikÃ§i, Kod, Gramaj, En, Elyaf bilgileri (Id, Code, Name, YÃ¼zde)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - image_url
              properties:
                image_url:
                  type: string
                  format: uri
                  description: PLM'den gelen kumaÅŸ etiket gÃ¶rseli URL'i
                  example: https://idm.eu1.inforcloudsuite.com/ca/api/resources/FPLM_Document-89057-2-LATEST?$token=...&$tenant=...
                document_id:
                  type: string
                  description: PLM dokÃ¼man ID (opsiyonel)
                  example: FPLM_Document-89057
                request_id:
                  type: string
                  description: Ä°stek takip ID (opsiyonel)
                  example: req-12345
                timestamp:
                  type: string
                  format: date-time
                  description: Ä°stek zamanÄ± (opsiyonel)
                  example: 2025-11-05T23:27:19Z
      responses:
        '200':
          description: Analiz baÅŸarÄ±lÄ±
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AnalysisResponse'
        '400':
          description: GeÃ§ersiz istek
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Sunucu hatasÄ±
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /analyze-and-create:
    post:
      tags:
        - Full Flow
      summary: Analiz + PLM'de kumaÅŸ kodu aÃ§
      description: |
        **TAM AKIÅ:** GÃ¶rsel analizi + PLM'de otomatik kumaÅŸ kodu aÃ§ma
        
        **AdÄ±mlar:**
        1. ğŸ“¸ GÃ¶rsel analizi (ChatGPT)
        2. ğŸ§¬ Elyaf mapping
        3. ğŸ”‘ OAuth token alma
        4. ğŸ­ PLM API'ye POST
        5. âœ… KumaÅŸ kodu aÃ§Ä±ldÄ±
        
        **Not:** `create_in_plm: false` ile sadece analiz yapÄ±labilir.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - image_url
              properties:
                image_url:
                  type: string
                  format: uri
                  description: PLM'den gelen kumaÅŸ etiket gÃ¶rseli URL'i
                  example: https://idm.eu1.inforcloudsuite.com/ca/api/resources/FPLM_Document-89057-2-LATEST?$token=...&$tenant=...
                document_id:
                  type: string
                  description: PLM dokÃ¼man ID (opsiyonel)
                  example: FPLM_Document-89057
                request_id:
                  type: string
                  description: Ä°stek takip ID (opsiyonel)
                  example: req-12345
                timestamp:
                  type: string
                  format: date-time
                  description: Ä°stek zamanÄ± (opsiyonel)
                  example: 2025-11-05T23:27:19Z
                create_in_plm:
                  type: boolean
                  description: "PLM'de kumaÅŸ kodu aÃ§Ä±lsÄ±n mÄ±? (default: true)"
                  example: true
      responses:
        '200':
          description: Tam akÄ±ÅŸ baÅŸarÄ±lÄ±
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FullFlowResponse'
        '400':
          description: GeÃ§ersiz istek
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Sunucu hatasÄ±
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    DetailedHealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
          example: healthy
        timestamp:
          type: string
          format: date-time
          example: 2025-12-04T12:00:00.000Z
        services:
          type: object
          properties:
            api:
              type: object
              properties:
                status:
                  type: string
                  example: healthy
                message:
                  type: string
                  example: Express API Ã§alÄ±ÅŸÄ±yor
                uptime_seconds:
                  type: integer
                  example: 3600
            openai:
              type: object
              properties:
                status:
                  type: string
                  enum: [healthy, unhealthy, unknown]
                  example: healthy
                message:
                  type: string
                  example: OpenAI API baÄŸlantÄ±sÄ± baÅŸarÄ±lÄ±
                api_key_configured:
                  type: boolean
                  example: true
                models_available:
                  type: integer
                  example: 15
            plm:
              type: object
              properties:
                status:
                  type: string
                  enum: [healthy, unhealthy, unknown]
                  example: healthy
                message:
                  type: string
                  example: PLM OAuth token baÅŸarÄ±yla alÄ±ndÄ±
                credentials_configured:
                  type: boolean
                  example: true
                token_status:
                  type: string
                  enum: [valid, failed, error, not_checked]
                  example: valid
                token_expires_in_seconds:
                  type: integer
                  example: 3600
            github:
              type: object
              properties:
                status:
                  type: string
                  example: info
                message:
                  type: string
                  example: GitHub sadece kod repository olarak kullanÄ±lÄ±yor
                repository:
                  type: string
                  example: https://github.com/YourRepo

    AnalysisResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            Tedarikcisi:
              type: string
              example: NISH KUMAÅ SAN. VE TÄ°C. LTD. ÅTÄ°.
            Tedarikci_Kodu:
              type: string
              example: NK1178
            Gramaj:
              type: integer
              example: 210
            En:
              type: integer
              example: 190
            Elyaf1Yuzde:
              type: integer
              example: 79
            Elyaf1:
              type: string
              example: Polyester
            Elyaf1Id:
              type: integer
              example: 13
            Elyaf1Code:
              type: string
              example: PES
            Elyaf2Yuzde:
              type: integer
              example: 21
            Elyaf2:
              type: string
              example: Pamuk
            Elyaf2Id:
              type: integer
              example: 9
            Elyaf2Code:
              type: string
              example: COT
        raw_chatgpt_response:
          type: object
          description: ChatGPT'nin ham cevabÄ± (debug iÃ§in)
        metadata:
          type: object
          properties:
            document_id:
              type: string
              nullable: true
            request_id:
              type: string
              nullable: true
            timestamp:
              type: string
              format: date-time
            processing_time_ms:
              type: integer
              example: 2345

    FullFlowResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        analysis:
          type: object
          properties:
            success:
              type: boolean
              example: true
            data:
              $ref: '#/components/schemas/FabricData'
            raw_chatgpt_response:
              type: object
        plm_creation:
          type: object
          nullable: true
          properties:
            success:
              type: boolean
              example: true
            plm_response:
              type: object
              properties:
                key:
                  type: integer
                  example: 105
                addedCode:
                  type: string
                  example: 20251105-232719473
                name:
                  type: string
                  example: NISH KUMAÅ SAN. VE TÄ°C. LTD. ÅTÄ°. - NK1178,210 GSM,79%21%Pamuk
            material_description:
              type: string
              example: NISH KUMAÅ SAN. VE TÄ°C. LTD. ÅTÄ°. - NK1178
        metadata:
          type: object
          properties:
            document_id:
              type: string
              nullable: true
            request_id:
              type: string
              nullable: true
            timestamp:
              type: string
              format: date-time
            processing_time_ms:
              type: integer
              example: 26350

    FabricData:
      type: object
      properties:
        Tedarikcisi:
          type: string
          example: NISH KUMAÅ SAN. VE TÄ°C. LTD. ÅTÄ°.
        Tedarikci_Kodu:
          type: string
          example: NK1178
        Gramaj:
          type: integer
          example: 210
        En:
          type: integer
          example: 190
        Elyaf1Yuzde:
          type: integer
          example: 79
        Elyaf1:
          type: string
          example: Polyester
        Elyaf1Id:
          type: integer
          example: 13
        Elyaf1Code:
          type: string
          example: PES

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
          example: image_url parametresi gerekli
        error_type:
          type: string
          example: ValidationError
        metadata:
          type: object
          properties:
            document_id:
              type: string
              nullable: true
            request_id:
              type: string
              nullable: true
            timestamp:
              type: string
              format: date-time
            processing_time_ms:
              type: integer

